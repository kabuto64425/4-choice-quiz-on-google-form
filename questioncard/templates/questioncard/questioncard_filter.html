{% extends "_base.html" %}
{% block content %}
    {% load crispy_forms_tags %}
    <div id="app" class="container">
        <div id="myModal" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">検索条件</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="閉じる">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form id="filter" method="get">
                        <div class="modal-body">
                            {{ filter.form|crispy }}
                        </div>
                    </form>
                    <div class="modal-footer">
                        <a class="btn btn-outline-dark" data-dismiss="modal">戻る</a>
                        <button type="submit" class="btn btn-outline-dark" form="filter">検索</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <a class="btn btn-secondary filtered" style="visibility:hidden" href="/?page=1">検索を解除</a>
                <div class="float-right mt-1">
                    <a class="btn btn-outline-dark" href="{% url 'deck_list' %}">戻る</a>
                    <a class="btn btn-outline-dark" href="{% url 'question_card_create' request.resolver_match.kwargs.deck_pk %}">新規</a>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <ul v-if="questionCardList.length" class="list-group">
                    <question-card-component v-for="(questionCard, index) in questionCardList"
                    :question-card-pk="questionCard.questionCardPk"
                    :question-text="questionCard.questionText"
                    :correct-answer="questionCard.correctAnswer"
                    :question-card-update-url="questionCard.questionCardUpdateUrl"
                    :number="index"
                    :is-first="index == 0"
                    :is-last="index == questionCardList.length - 1"
                    @up="up"
                    @down="down"></my-template>
                </ul>
                <ul v-else>
                    <li class="list-group-item">
                        対象のデータがありません
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <script>
        const questionCardListFromServer = [
            {% for questioncard in questioncard_list %}
                {
                    questionCardPk: "{{questioncard.pk}}",
                    questionText: "{{ questioncard.question_text|default_if_none:'未入力' }}",
                    correctAnswer: "{{ questioncard.correct_answer|default_if_none:'未入力' }}",
                    questionCardUpdateUrl: "{% url 'question_card_update' questioncard.pk %}",
                },
            {% endfor %}
        ];

        const QuestionCardComponent = {
            props:["questionCardPk", "questionText", "correctAnswer", "questionCardUpdateUrl", "number", "isFirst", "isLast"],
            template: `
                <li class="list-group-item question_card">
                    {# 必要な項目を追加してください #}
                    <div class="row ">
                        <div class="col-11">
                            <div class="row">
                                <div class="col-5 col-sm-3">
                                    <p>問題文</p>
                                </div>
                                <div class="col-7 col-sm-9">
                                    <p>[[questionText]]</p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-5 col-sm-3">
                                    <p>正解</p>
                                </div>
                                <div class="col-7 col-sm-9">
                                    <p>[[correctAnswer]]</p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="float-right">
                                        <a class="btn btn-outline-dark " v-bind:href="questionCardUpdateUrl">編集</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-1">
                            <div class="row">
                                <div class="float-right">
                                    <a class="btn btn-outline-dark" :class="{'disabled' : isFirst}" href="#" @click.prevent.stop="up">↑</a>
                                </div>
                            </div>
                            <div class="row">
                                <div class="float-right">
                                    <a class="btn btn-outline-dark" :class="{'disabled' : isLast}" href="#" @click.prevent.stop="down">↓</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if False %}
                    <div class="row">
                        <div class="col-12">
                            <div class="float-right">
                                <a class="btn btn-outline-dark " href="{% url 'deck_update' deck.pk %}">編集</a>
                                <a class="btn btn-outline-dark " href="{% url 'delete' deck.pk %}">削除</a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </li>`
                ,
            methods:{
                up: function(){
                    this.$emit("up", this.number);
                },
                down: function(){
                    this.$emit("down", this.number);
                }
            },
            delimiters: ['[[', ']]']
        };

        const app = Vue.createApp({
            data() {
                return {
                    questionCardList : questionCardListFromServer,
                }
            },
            methods: {
                up: function(number) {
                    console.log(number);
                    console.log(this.questionCardList[number]);
                    axios.defaults.xsrfCookieName = 'csrftoken'
                    axios.defaults.xsrfHeaderName = "X-Csrftoken"
                    axios.post("{% url 'question_card_swap' %}", {
                        questionCardPk1: this.questionCardList[number].questionCardPk,
                        questionCardPk2: this.questionCardList[number - 1].questionCardPk
                    })
                    .then((res) => {
                        [this.questionCardList[number], this.questionCardList[number - 1]] = [this.questionCardList[number - 1], this.questionCardList[number]];
                    });
                },
                down: function(number) {
                    console.log(number);
                    console.log(this.questionCardList[number]);
                    axios.defaults.xsrfCookieName = 'csrftoken'
                    axios.defaults.xsrfHeaderName = "X-Csrftoken"
                    axios.post("{% url 'question_card_swap' %}", {
                        questionCardPk1: this.questionCardList[number].questionCardPk,
                        questionCardPk2: this.questionCardList[number + 1].questionCardPk
                    })
                    .then((res) => {
                        [this.questionCardList[number], this.questionCardList[number + 1]] = [this.questionCardList[number + 1], this.questionCardList[number]];
                    });
                }
            },
            delimiters: ['[[', ']]']
        }).component("question-card-component", QuestionCardComponent).mount("#app");
    </script>
{% endblock %}